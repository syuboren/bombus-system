<app-header
  pageTitle="候選人檔案解析"
  [breadcrumbs]="['招募職缺管理', '資深前端工程師', candidate()?.name || '']" />

<main class="main-content">
  <div class="content-container">
    @if (candidate(); as c) {
      <!-- Candidate Header -->
      <div class="candidate-header">
        <div class="candidate-basic">
          <div class="candidate-avatar" [style.background-color]="c.avatarColor">
            {{ getInitial(c.name) }}
          </div>
          <div class="candidate-info">
            <h2>{{ c.name }} ({{ c.nameEn }})</h2>
            <div class="contact-info">
              <span><i class="ri-mail-line"></i> {{ c.email }}</span>
              @if (c.phone) {
                <span><i class="ri-phone-line"></i> {{ c.phone }}</span>
              }
              @if (c.location) {
                <span><i class="ri-map-pin-line"></i> {{ c.location }}</span>
              }
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="goBack()" type="button">
            <i class="ri-arrow-left-line"></i>
            返回列表
          </button>
          <button class="btn btn-secondary" (click)="downloadResume()" type="button">
            <i class="ri-download-line"></i>
            下載履歷
          </button>
          <button class="btn btn-primary" (click)="goToInterview()" type="button">
            <i class="ri-mic-line"></i>
            進入面試評核
          </button>
        </div>
      </div>

      <!-- Split Container -->
      <div class="split-container">
        <!-- Left: Resume Preview -->
        <div class="panel">
          <div class="panel__header">
            <div class="panel__title">
              <i class="ri-file-pdf-line"></i>
              原始履歷預覽
            </div>
            <span class="file-name">{{ c.resumeUrl }}</span>
          </div>
          <div class="panel__content resume-preview">
            <div class="resume-page">
              <h2 class="resume-name">{{ c.nameEn }}</h2>
              <p class="resume-intro">
                <strong>Senior Frontend Developer</strong> with {{ c.experienceYears }}+ years of experience in building responsive web applications.
              </p>

              <h3 class="resume-section-title">Experience</h3>
              @for (exp of c.aiAnalysis.experiences; track exp.company) {
                <div class="resume-exp">
                  <strong>{{ exp.company }}</strong>
                  <br>
                  <em>{{ exp.position }}</em>
                  @if (exp.highlights.length > 0) {
                    <ul>
                      @for (h of exp.highlights; track h) {
                        <li>{{ h }}</li>
                      }
                    </ul>
                  }
                </div>
              }

              <h3 class="resume-section-title">Education</h3>
              <div class="resume-edu">
                <strong>{{ c.aiAnalysis.education.school }}</strong>
                <br>
                <em>{{ c.aiAnalysis.education.degree }} in {{ c.aiAnalysis.education.major }}</em>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: AI Analysis -->
        <div class="panel">
          <div class="panel__header">
            <div class="panel__title">
              <i class="ri-magic-line"></i>
              AI 履歷解析報告
            </div>
            <span class="status-badge status--success">解析完成</span>
          </div>
          <div class="panel__content">
            <!-- Match Score -->
            <div class="match-score-card">
              <div class="score-circle">{{ c.aiAnalysis.matchScore }}</div>
              <div class="score-label">JD 職能匹配度</div>
              <div class="score-desc">基於職能需求綜合評估</div>
            </div>

            <!-- Competency Matching Section (NEW) -->
            @if (c.aiAnalysis.competencyMatches && c.aiAnalysis.competencyMatches.length > 0) {
              <div class="analysis-section competency-section">
                <div class="section-label section-label--highlight">
                  <i class="ri-bar-chart-box-line"></i>
                  職能需求匹配分析
                  <span class="badge-ai">AI 評分</span>
                </div>
                <div class="competency-matches">
                  @for (match of c.aiAnalysis.competencyMatches; track match.competencyId) {
                    <div class="competency-match-item">
                      <div class="match-header">
                        <div class="match-info">
                          <span class="competency-type {{ getCompetencyTypeClass(match.type) }}">
                            {{ getCompetencyTypeLabel(match.type) }}
                          </span>
                          <span class="competency-name">{{ match.competencyName }}</span>
                        </div>
                        <div class="match-score {{ getMatchScoreClass(match.score) }}">
                          {{ match.score }}分
                        </div>
                      </div>
                      <div class="match-levels">
                        <div class="level-info">
                          <span class="level-label">要求等級</span>
                          <div class="level-dots">
                            @for (i of [1,2,3,4,5]; track i) {
                              <span class="level-dot {{ i <= match.requiredLevel ? 'level-dot--required' : '' }}"></span>
                            }
                          </div>
                          <span class="level-value">Lv.{{ match.requiredLevel }}</span>
                        </div>
                        <div class="level-info">
                          <span class="level-label">評估等級</span>
                          <div class="level-dots">
                            @for (i of [1,2,3,4,5]; track i) {
                              <span class="level-dot {{ i <= match.assessedLevel ? 'level-dot--assessed' : '' }}"></span>
                            }
                          </div>
                          <span class="level-value">Lv.{{ match.assessedLevel }}</span>
                        </div>
                      </div>
                      <div class="match-evidence">
                        <i class="ri-lightbulb-line"></i>
                        {{ match.evidence }}
                      </div>
                      <div class="match-weight">
                        權重：{{ match.weight }}%
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Skills Section -->
            <div class="analysis-section">
              <div class="section-label">
                <i class="ri-code-box-line"></i>
                技能標籤提取
              </div>
              <div class="skill-tags">
                @for (skill of c.aiAnalysis.skills; track skill.name) {
                  <span class="skill-tag {{ getSkillClass(skill.level) }}">
                    @if (skill.matched) {
                      <i class="ri-check-line"></i>
                    }
                    {{ skill.name }}
                  </span>
                }
              </div>
            </div>

            <!-- Experience Section -->
            <div class="analysis-section">
              <div class="section-label">
                <i class="ri-briefcase-line"></i>
                經歷摘要
              </div>
              @for (exp of c.aiAnalysis.experiences; track exp.company) {
                <div class="info-card">
                  <div class="info-card__header">
                    <span class="company-name">{{ exp.company }}</span>
                    <span class="duration">{{ exp.duration }}</span>
                  </div>
                  <div class="position">{{ exp.position }}</div>
                  @if (exp.highlights.length > 0) {
                    <div class="highlights">
                      @for (h of exp.highlights; track h) {
                        <span>• {{ h }}</span>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Education Section -->
            <div class="analysis-section">
              <div class="section-label">
                <i class="ri-graduation-cap-line"></i>
                學歷驗證
              </div>
              <div class="info-card">
                <div class="info-card__header">
                  <span class="company-name">{{ c.aiAnalysis.education.school }}</span>
                  @if (c.aiAnalysis.education.verified) {
                    <i class="ri-verified-badge-fill verified-icon"></i>
                  }
                </div>
                <div class="position">{{ c.aiAnalysis.education.major }} {{ c.aiAnalysis.education.degree }}</div>
              </div>
            </div>

            <!-- AI Suggestions Section (NEW) -->
            <div class="analysis-section ai-suggestions-section">
              <div class="section-label section-label--ai">
                <i class="ri-lightbulb-flash-line"></i>
                AI 綜合建議
                <span class="badge-ai">AI 分析</span>
              </div>
              
              <div class="ai-suggestions-grid">
                <!-- 優勢 -->
                <div class="suggestion-card suggestion-card--strength">
                  <div class="suggestion-header">
                    <i class="ri-thumb-up-line"></i>
                    <span>優勢</span>
                  </div>
                  <ul class="suggestion-list">
                    <li>具備 {{ c.experienceYears }} 年相關工作經驗，經驗豐富</li>
                    <li>心理學背景有助於行為面試與人才評估</li>
                    <li>曾獨立完成年度招募超過 50 人，執行力強</li>
                    <li>熟悉多元招募管道，具備獵頭經驗</li>
                  </ul>
                </div>

                <!-- 不足之處 -->
                <div class="suggestion-card suggestion-card--weakness">
                  <div class="suggestion-header">
                    <i class="ri-alert-line"></i>
                    <span>不足之處</span>
                  </div>
                  <ul class="suggestion-list">
                    <li>尚未有 HRIS 系統操作經驗</li>
                    <li>缺乏薪酬福利規劃相關經驗</li>
                    <li>跨部門協調經驗較少</li>
                  </ul>
                </div>

                <!-- 建議 -->
                <div class="suggestion-card suggestion-card--recommendation">
                  <div class="suggestion-header">
                    <i class="ri-chat-check-line"></i>
                    <span>面試建議</span>
                  </div>
                  <ul class="suggestion-list">
                    <li>建議深入了解過往招募案例的具體成效</li>
                    <li>評估對公司 HRIS 系統的學習意願與能力</li>
                    <li>可詢問跨部門合作的經驗與處理方式</li>
                    <li>確認對薪資福利的期望是否符合公司預算</li>
                  </ul>
                </div>
              </div>

              <!-- AI 評分資訊 -->
              <div class="ai-scoring-info">
                <div class="scoring-info-item">
                  <i class="ri-time-line"></i>
                  <span>AI 評分時間：2025/11/25 14:32:18</span>
                </div>
                <div class="scoring-info-item">
                  <i class="ri-robot-line"></i>
                  <span>AI 模型版本：Bombus AI v2.1</span>
                </div>
                <div class="scoring-info-item">
                  <i class="ri-file-text-line"></i>
                  <span>分析履歷字數：1,248 字</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>載入中...</p>
      </div>
    }
  </div>
</main>

