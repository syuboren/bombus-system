<app-header [pageTitle]="pageTitle" [breadcrumbs]="breadcrumbs" />

<div class="job-description-page">
  <!-- Stats Cards -->
  <section class="stats-section">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon total">
          <i class="ri-file-list-3-line"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ stats().total }}</span>
          <span class="stat-label">職務說明書總數</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon published">
          <i class="ri-checkbox-circle-line"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ stats().published }}</span>
          <span class="stat-label">已發布</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon draft">
          <i class="ri-draft-line"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ stats().draft }}</span>
          <span class="stat-label">草稿</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon archived">
          <i class="ri-archive-line"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ stats().archived }}</span>
          <span class="stat-label">已封存</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="filter-section">
    <div class="filter-bar">
      <div class="filter-item">
        <label class="filter-label">關鍵字搜尋</label>
          <input
            type="text"
          class="filter-input"
          placeholder="職位名稱 / 代碼"
            [ngModel]="searchKeyword()"
          (ngModelChange)="onSearchChange($event)">
        </div>
      <div class="filter-item">
        <label class="filter-label">部門篩選</label>
        <select class="filter-select" [ngModel]="selectedDepartment()" (ngModelChange)="onDepartmentChange($event)">
          @for (opt of departmentOptions; track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
      <div class="filter-item">
        <label class="filter-label">狀態</label>
        <select class="filter-select" [ngModel]="selectedStatus()" (ngModelChange)="onStatusChange($event)">
          @for (opt of statusOptions; track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
      <div class="filter-item filter-item--action">
        <button class="btn-primary" type="button" (click)="router.navigate(['/competency/job-description/create'])">
          <i class="ri-add-line"></i>
          新增職務說明書
        </button>
      </div>
    </div>
  </section>

  <!-- View Toggle & Count -->
  <section class="toolbar-section">
    <div class="toolbar-bar">
        <div class="view-toggle">
          <button
            class="view-btn"
            [class.active]="viewMode() === 'card'"
            (click)="setViewMode('card')"
            type="button">
            <i class="ri-layout-grid-line"></i>
          </button>
          <button
            class="view-btn"
            [class.active]="viewMode() === 'list'"
            (click)="setViewMode('list')"
            type="button">
            <i class="ri-list-check"></i>
          </button>
        </div>
        <span class="result-count">共 <strong>{{ filteredJDs().length }}</strong> 筆</span>
    </div>
  </section>

  @if (loading()) {
    <div class="loading-container">
      <i class="ri-loader-4-line spinner"></i>
      <span>載入資料中...</span>
    </div>
  } @else {
    <!-- Card View -->
    @if (viewMode() === 'card') {
      <section class="content-section">
        <div class="jd-grid">
          @for (jd of filteredJDs(); track jd.id) {
            <div class="jd-card" (click)="openDetailModal(jd)">
              <div class="jd-card-header">
                <span class="jd-code">{{ jd.positionCode }}</span>
                <span class="jd-status" [class]="getStatusClass(jd.status)">
                  {{ getStatusLabel(jd.status) }}
                </span>
              </div>
              <h3 class="jd-name">{{ jd.positionName }}</h3>
              <div class="jd-meta">
                <span class="meta-item">
                  <i class="ri-building-line"></i> {{ jd.department }}
                </span>
                <span class="meta-item">
                  <i class="ri-bar-chart-box-line"></i> {{ jd.gradeLevel }}
                </span>
              </div>
              <p class="jd-summary">{{ jd.summary }}</p>
              <div class="jd-competencies">
                <span class="competencies-label">
                  <i class="ri-puzzle-line"></i> 職能需求
                </span>
                <div class="competencies-tags">
                  @for (comp of jd.requiredCompetencies.slice(0, 3); track comp.competencyId) {
                    <span class="competency-tag" [class]="getCompetencyTypeClass(comp.type)">
                      {{ comp.competencyName }}
                    </span>
                  }
                  @if (jd.requiredCompetencies.length > 3) {
                    <span class="competency-more">+{{ jd.requiredCompetencies.length - 3 }}</span>
                  }
                </div>
              </div>
              <div class="jd-card-footer">
                <span class="version">v{{ jd.version }}</span>
                <span class="update-date">更新: {{ formatDate(jd.updatedAt) }}</span>
              </div>
            </div>
          }
        </div>
      </section>
    }

    <!-- List View -->
    @if (viewMode() === 'list') {
      <section class="content-section">
        <div class="jd-table-container">
          <table class="jd-table">
            <thead>
              <tr>
                <th>職位代碼</th>
                <th>職位名稱</th>
                <th>部門</th>
                <th>職等</th>
                <th>職能數</th>
                <th>狀態</th>
                <th>版本</th>
                <th>更新日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              @for (jd of filteredJDs(); track jd.id) {
                <tr (click)="openDetailModal(jd)">
                  <td class="code-cell">{{ jd.positionCode }}</td>
                  <td class="name-cell">{{ jd.positionName }}</td>
                  <td>{{ jd.department }}</td>
                  <td>{{ jd.gradeLevel }}</td>
                  <td>{{ jd.requiredCompetencies.length }}</td>
                  <td>
                    <span class="jd-status" [class]="getStatusClass(jd.status)">
                      {{ getStatusLabel(jd.status) }}
                    </span>
                  </td>
                  <td>v{{ jd.version }}</td>
                  <td>{{ formatDate(jd.updatedAt) }}</td>
                  <td class="action-cell">
                    <button class="btn-icon" type="button" (click)="$event.stopPropagation()">
                      <i class="ri-edit-line"></i>
                    </button>
                    <button class="btn-icon" type="button" (click)="$event.stopPropagation()">
                      <i class="ri-file-copy-line"></i>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    }

    @if (filteredJDs().length === 0) {
      <div class="empty-state">
        <i class="ri-file-search-line"></i>
        <p>找不到符合條件的職務說明書</p>
      </div>
    }
  }
</div>

<!-- Detail Modal -->
@if (showDetailModal() && selectedJD(); as jd) {
  <div class="modal-backdrop" (click)="closeDetailModal()"></div>
  <div class="modal modal--large">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-header-info">
          <span class="jd-code">{{ jd.positionCode }}</span>
          <span class="jd-status" [class]="getStatusClass(jd.status)">
            {{ getStatusLabel(jd.status) }}
          </span>
        </div>
        <button class="btn-close" (click)="closeDetailModal()" type="button">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- 區塊 1: 基本資訊 -->
        <div class="jd-detail-block">
          <div class="block-header">
            <span class="block-number">1</span>
            <h4 class="block-title">基本資訊</h4>
          </div>
          <div class="block-content">
            <h2 class="position-name">{{ jd.positionName }}</h2>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">職位代碼</span>
                <span class="info-value">{{ jd.positionCode }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">部門</span>
                <span class="info-value">{{ jd.department }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">職等</span>
                <span class="info-value">{{ jd.gradeLevel }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">版本</span>
                <span class="info-value">{{ jd.version }}</span>
              </div>
            </div>
            @if (jd.summary) {
              <div class="summary-box">
                <p>{{ jd.summary }}</p>
              </div>
            }
          </div>
        </div>

        <!-- 區塊 2: 主要職責 -->
        @if (jd.responsibilities && jd.responsibilities.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">2</span>
              <h4 class="block-title">主要職責</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.responsibilities; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
        </div>
        }

        <!-- 區塊 3: 職務目的 -->
        @if (jd.jobPurpose && jd.jobPurpose.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">3</span>
              <h4 class="block-title">職務目的</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.jobPurpose; track item) {
                  <li>{{ item }}</li>
            }
          </ul>
        </div>
          </div>
        }

        <!-- 區塊 4: 職務要求 -->
        @if (jd.qualifications && jd.qualifications.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">4</span>
              <h4 class="block-title">職務要求</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.qualifications; track item) {
                  <li>{{ item }}</li>
            }
          </ul>
        </div>
          </div>
        }

        <!-- 區塊 5: 最終有價值產品 VFP -->
        @if (jd.vfp && jd.vfp.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">5</span>
              <h4 class="block-title">最終有價值產品 VFP</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.vfp; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 區塊 6: 職能需求 -->
        <div class="jd-detail-block">
          <div class="block-header">
            <span class="block-number">6</span>
            <h4 class="block-title">職能需求</h4>
            <span class="total-weight" [class.warning]="getAllCompetenciesTotalWeight(jd) !== 100">
              總權重：{{ getAllCompetenciesTotalWeight(jd) }}%
                  </span>
          </div>
          <div class="block-content">
            <div class="competency-sections">
              <!-- 核心職能 -->
              <div class="competency-section">
                <h5 class="competency-section-title">
                  <i class="ri-heart-pulse-line"></i>
                  核心職能
                </h5>
                @if (jd.coreCompetencyRequirements && jd.coreCompetencyRequirements.length > 0) {
                  <table class="competency-table">
                    <thead>
                      <tr>
                        <th>職能名稱</th>
                        <th>需求等級</th>
                        <th>權重</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (comp of jd.coreCompetencyRequirements; track comp.competencyId) {
                        <tr>
                          <td>{{ comp.competencyName }}</td>
                          <td><span class="level-badge core">{{ comp.requiredLevel }}</span></td>
                          <td><span class="weight-badge">{{ comp.weight }}%</span></td>
                        </tr>
                      }
                    </tbody>
                  </table>
                } @else {
                  <span class="no-data">未設定</span>
                }
              </div>

              <!-- 管理職能 -->
              <div class="competency-section">
                <h5 class="competency-section-title">
                  <i class="ri-team-line"></i>
                  管理職能
                </h5>
                @if (jd.managementCompetencyRequirements && jd.managementCompetencyRequirements.length > 0) {
                  <table class="competency-table">
                    <thead>
                      <tr>
                        <th>職能名稱</th>
                        <th>需求等級</th>
                        <th>權重</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (comp of jd.managementCompetencyRequirements; track comp.competencyId) {
                        <tr>
                          <td>{{ comp.competencyName }}</td>
                          <td><span class="level-badge management">{{ comp.requiredLevel }}</span></td>
                          <td><span class="weight-badge">{{ comp.weight }}%</span></td>
                        </tr>
                      }
                    </tbody>
                  </table>
                } @else {
                  <span class="no-data">未設定</span>
                }
              </div>

              <!-- KSA 職能 -->
              <div class="competency-section">
                <h5 class="competency-section-title">
                  <i class="ri-book-3-line"></i>
                  KSA 職能
                </h5>
                @if (jd.ksaCompetencyRequirements && jd.ksaCompetencyRequirements.length > 0) {
                  <table class="competency-table">
                    <thead>
                      <tr>
                        <th>職能名稱</th>
                        <th>類型</th>
                        <th>權重</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (comp of jd.ksaCompetencyRequirements; track comp.competencyId) {
                        <tr>
                          <td>{{ comp.competencyName }}</td>
                          <td><span class="ksa-type-badge" [class]="'type-' + comp.ksaType">{{ getKSACompetencyTypeLabel(comp.ksaType) }}</span></td>
                          <td><span class="weight-badge">{{ comp.weight }}%</span></td>
                        </tr>
                      }
                    </tbody>
                  </table>
                } @else if (jd.ksaContent) {
                  @if (jd.ksaContent.knowledge && jd.ksaContent.knowledge.length > 0) {
                    <div class="ksa-category">
                      <span class="ksa-label">知識 (Knowledge)</span>
                      <div class="competency-tags">
                        @for (item of jd.ksaContent.knowledge; track item.code) {
                          <span class="competency-tag knowledge">{{ item.code }} - {{ item.name }}</span>
                        }
                      </div>
                    </div>
                  }
                  @if (jd.ksaContent.skills && jd.ksaContent.skills.length > 0) {
                    <div class="ksa-category">
                      <span class="ksa-label">技能 (Skills)</span>
                      <div class="competency-tags">
                        @for (item of jd.ksaContent.skills; track item.code) {
                          <span class="competency-tag skill">{{ item.code }} - {{ item.name }}</span>
                        }
                      </div>
                    </div>
                  }
                  @if (jd.ksaContent.attitudes && jd.ksaContent.attitudes.length > 0) {
                    <div class="ksa-category">
                      <span class="ksa-label">態度 (Attitude)</span>
                      <div class="competency-tags">
                        @for (item of jd.ksaContent.attitudes; track item.code) {
                          <span class="competency-tag attitude">{{ item.code }} - {{ item.name }}</span>
                        }
                      </div>
                    </div>
                  }
                } @else {
                  <span class="no-data">未設定</span>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- 區塊 7: 工作描述 -->
        @if (jd.workDescription && jd.workDescription.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">7</span>
              <h4 class="block-title">工作描述</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.workDescription; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 區塊 8: 檢查清單 -->
        @if (jd.checklist && jd.checklist.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">8</span>
              <h4 class="block-title">檢查清單</h4>
            </div>
            <div class="block-content">
              <div class="checklist-table">
                <div class="checklist-header">
                  <span class="checklist-col-item">檢查項目</span>
                  <span class="checklist-col-points">分數</span>
                </div>
                @for (item of jd.checklist; track item.item) {
                  <div class="checklist-row">
                    <span class="checklist-item">{{ item.item }}</span>
                    <span class="checklist-points">{{ item.points }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- 區塊 9: 職務責任 -->
        @if (jd.jobDuties && jd.jobDuties.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">9</span>
              <h4 class="block-title">職務責任</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.jobDuties; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 區塊 10: 每日工作 -->
        @if (jd.dailyTasks && jd.dailyTasks.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">10</span>
              <h4 class="block-title">每日工作</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.dailyTasks; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 區塊 11: 每週工作 -->
        @if (jd.weeklyTasks && jd.weeklyTasks.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">11</span>
              <h4 class="block-title">每週工作</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.weeklyTasks; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 區塊 12: 每月工作 -->
        @if (jd.monthlyTasks && jd.monthlyTasks.length > 0) {
          <div class="jd-detail-block">
            <div class="block-header">
              <span class="block-number">12</span>
              <h4 class="block-title">每月工作</h4>
            </div>
            <div class="block-content">
              <ul class="content-list">
                @for (item of jd.monthlyTasks; track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- 版本資訊 -->
        <div class="jd-detail-block version-block">
          <div class="block-header">
            <h4 class="block-title">版本資訊</h4>
          </div>
          <div class="block-content">
            <div class="version-grid">
            <div class="version-item">
              <span class="version-label">建立者</span>
              <span class="version-value">{{ jd.createdBy }}</span>
            </div>
            <div class="version-item">
              <span class="version-label">建立日期</span>
              <span class="version-value">{{ formatDate(jd.createdAt) }}</span>
            </div>
            <div class="version-item">
              <span class="version-label">最後更新</span>
              <span class="version-value">{{ formatDate(jd.updatedAt) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 歷次版本記錄 -->
        <div class="jd-detail-block history-block">
          <div class="block-header">
            <h4 class="block-title">歷次版本記錄</h4>
          </div>
          <div class="block-content">
            <div class="version-history">
              <div class="history-item current">
                <div class="history-version">v{{ jd.version }}</div>
                <div class="history-info">
                  <span class="history-date">{{ formatDate(jd.updatedAt) }}</span>
                  <span class="history-author">{{ jd.createdBy }}</span>
                  <span class="history-badge current">目前版本</span>
                </div>
                <div class="history-note">更新職能需求與工作職責</div>
              </div>
              <div class="history-item">
                <div class="history-version">v0.9</div>
                <div class="history-info">
                  <span class="history-date">{{ formatDate(jd.createdAt) }}</span>
                  <span class="history-author">{{ jd.createdBy }}</span>
                </div>
                <div class="history-note">初始版本建立</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDetailModal()" type="button">關閉</button>
        <button class="btn-secondary" type="button" (click)="exportToPdf()" [disabled]="isExporting()">
          @if (isExporting()) {
            <i class="ri-loader-4-line spin"></i> 匯出中...
          } @else {
          <i class="ri-download-line"></i> 匯出 PDF
          }
        </button>
        <button class="btn-primary" type="button">
          <i class="ri-edit-line"></i> 編輯
        </button>
      </div>
    </div>
  </div>
}


