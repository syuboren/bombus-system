<div class="map-card">
  <header class="map-card__header">
    <h2 class="map-card__title">
      <i class="ri-fire-fill"></i>
      çµ„ç¹”è·èƒ½ç†±åŠ›åœ– (Competency Heatmap)
    </h2>
    <p class="map-card__desc">
      å¿«é€Ÿå®šä½çµ„ç¹”è·èƒ½çŸ­æ¿ï¼Œå„ªå…ˆå®‰æ’åŸ¹è¨“è³‡æºã€‚ä½¿ç”¨ç´…ç¶ ç‡ˆè™Ÿè¦–è¦ºåŒ–å‘ˆç¾å„éƒ¨é–€/å“¡å·¥çš„è·èƒ½å¼·å¼±ã€‚
    </p>
  </header>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="viewLevel">è¦–åœ–å±¤ç´š:</label>
      <select
        id="viewLevel"
        [value]="filter().viewLevel"
        (change)="updateFilter('viewLevel', $any($event.target).value)">
        @for (opt of viewLevelOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="deptFilter">é¸æ“‡éƒ¨é–€:</label>
      <select
        id="deptFilter"
        [value]="filter().department"
        (change)="updateFilter('department', $any($event.target).value)">
        @for (opt of departmentOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="competencyType">è·èƒ½é¡å‹:</label>
      <select
        id="competencyType"
        [value]="filter().competencyType"
        (change)="updateFilter('competencyType', $any($event.target).value)">
        @for (opt of competencyTypeOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Statistics -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-label">å¹³å‡åˆ†æ•¸</span>
      <span class="stat-value stat-value--primary">{{ stats().avgScore }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">å„ªç§€è·èƒ½æ•¸</span>
      <span class="stat-value stat-value--success">{{ stats().excellentCount }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">éœ€åŸ¹è¨“äººæ•¸</span>
      <span class="stat-value stat-value--danger">{{ stats().needTrainingCount }}</span>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-wrapper">
    @if (loading()) {
      <div class="chart-loading">
        <i class="ri-loader-4-line"></i>
        <span>è¼‰å…¥ä¸­...</span>
      </div>
    }
    <div #heatmapChart class="chart-container"></div>
  </div>

  <!-- Export Button -->
  <button class="export-btn" (click)="exportChart()" type="button">
    <i class="ri-download-2-line"></i>
    åŒ¯å‡º PNG
  </button>
</div>

<!-- Detail Modal -->
@if (showDetailModal()) {
  <div class="modal-overlay" (click)="closeDetailModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeDetailModal()" type="button">&times;</button>
      
      @if (selectedDetail(); as detail) {
        <h3 class="modal-title">{{ detail.competency }} - {{ detail.department }}</h3>
        <p class="modal-subtitle">è·èƒ½ç‹€æ…‹ï¼š{{ detail.level.label }}</p>

        <!-- Score Grid -->
        <div class="score-grid">
          <div class="score-item">
            <span class="score-item__label">ç•¶å‰åˆ†æ•¸</span>
            <span class="score-item__value" [style.color]="detail.level.color">
              {{ detail.score }} åˆ†
            </span>
          </div>
          <div class="score-item">
            <span class="score-item__label">è¦æ±‚åˆ†æ•¸</span>
            <span class="score-item__value score-item__value--muted">
              {{ detail.requiredScore }} åˆ†
            </span>
          </div>
          <div class="score-item">
            <span class="score-item__label">è½å·®</span>
            <span class="score-item__value" [class.positive]="detail.gap >= 0" [class.negative]="detail.gap < 0">
              {{ detail.gap >= 0 ? '+' : '' }}{{ detail.gap }} åˆ†
            </span>
          </div>
          <div class="score-item">
            <span class="score-item__label">éƒ¨é–€æ’å</span>
            <span class="score-item__value">{{ detail.rank }}</span>
          </div>
        </div>

        <!-- Recommended Courses -->
        <div class="courses-section">
          <h4 class="courses-title">
            <span>ğŸ’¡</span> AI æ¨è–¦èª²ç¨‹
          </h4>
          <ul class="courses-list">
            @for (course of detail.courses; track course.name) {
              <li class="course-item">
                <span class="course-icon">ğŸ“š</span>
                <span class="course-name">{{ course.name }}</span>
                <span class="course-improvement">(é ä¼°æå‡ +{{ course.improvement }} åˆ†)</span>
              </li>
            }
          </ul>
        </div>

        <!-- Actions -->
        <div class="modal-actions">
          <button class="btn-secondary" (click)="viewHistory()" type="button">
            <i class="ri-history-line"></i>
            æŸ¥çœ‹æ­·å²ç´€éŒ„
          </button>
          <button class="btn-primary" (click)="assignTraining()" type="button">
            <i class="ri-graduation-cap-line"></i>
            æŒ‡æ´¾åŸ¹è¨“èª²ç¨‹
          </button>
        </div>
      }
    </div>
  </div>
}
